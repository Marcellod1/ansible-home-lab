- name: Create {{ target_dir }}
  become: true
  ansible.builtin.file:
    path: "{{ target_dir }}"
    mode: '775'
    group: docker
    state: directory
  vars:
    target_dir: "{{ docker_directory | regex_replace('/+$', '') }}/{{ container_name }}/data"

- name: Create {{ target_dir }}
  become: true
  ansible.builtin.file:
    path: "{{ target_dir }}"
    mode: '775'
    group: docker
    state: directory
  vars:
    target_dir: "{{ docker_directory | regex_replace('/+$', '') }}/{{ container_name }}/letsencrypt"

- name: Start nginx-proxy-manager container
  become: true
  community.docker.docker_container:
    name: nginx-proxy-manager
    image: jc21/nginx-proxy-manager:latest
    state: started
    restart: true
    ports:
      - 80:80
      - 81:81
      - 443:443
    mounts:
      - source: "{{ docker_directory | regex_replace('/+$', '') }}/{{ container_name }}/data"
        target: /data
        type: bind
      - source: "{{ docker_directory | regex_replace('/+$', '') }}/{{ container_name }}/letsencrypt"
        target: /etc/letsencrypt
        type: bind
